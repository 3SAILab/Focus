name: Cleanup Artifacts

on:
  # 手动触发
  workflow_dispatch:
  # 每周一凌晨自动清理
  schedule:
    - cron: '0 0 * * 1'

permissions:
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete all artifacts using GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Listing all artifacts ==="
          
          # 获取所有 artifacts 并删除
          ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/artifacts --paginate -q '.artifacts[].id')
          
          if [ -z "$ARTIFACTS" ]; then
            echo "No artifacts found"
            exit 0
          fi
          
          COUNT=0
          for ID in $ARTIFACTS; do
            echo "Deleting artifact ID: $ID"
            gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$ID || true
            COUNT=$((COUNT + 1))
          done
          
          echo ""
          echo "=== Summary ==="
          echo "Deleted $COUNT artifacts"
          
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Deleting old workflow runs ==="
          
          # 保留最近 5 次运行，删除其他的
          RUNS=$(gh run list --limit 200 --json databaseId -q '.[2:][].databaseId')
          
          if [ -z "$RUNS" ]; then
            echo "No old runs to delete"
            exit 0
          fi
          
          COUNT=0
          for ID in $RUNS; do
            echo "Deleting run ID: $ID"
            gh run delete $ID || true
            COUNT=$((COUNT + 1))
          done
          
          echo ""
          echo "=== Summary ==="
          echo "Deleted $COUNT workflow runs"
