name: Cleanup Artifacts

on:
  # 手动触发
  workflow_dispatch:
  # 每周一凌晨自动清理
  schedule:
    - cron: '0 0 * * 1'

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete all artifacts using GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "=== Deleting all artifacts from $REPO ==="
          
          # 获取所有 artifacts 并删除
          ARTIFACTS=$(gh api repos/$REPO/actions/artifacts --paginate -q '.artifacts[].id' 2>/dev/null || echo "")
          
          if [ -z "$ARTIFACTS" ]; then
            echo "No artifacts found"
          else
            COUNT=0
            for ID in $ARTIFACTS; do
              echo "Deleting artifact ID: $ID"
              gh api -X DELETE repos/$REPO/actions/artifacts/$ID 2>/dev/null || true
              COUNT=$((COUNT + 1))
            done
            echo "Deleted $COUNT artifacts"
          fi
          
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "=== Deleting old workflow runs ==="
          
          # 保留最近 5 次运行，删除其他的
          RUNS=$(gh api repos/$REPO/actions/runs --paginate -q '.workflow_runs[5:][].id' 2>/dev/null || echo "")
          
          if [ -z "$RUNS" ]; then
            echo "No old runs to delete"
          else
            COUNT=0
            for ID in $RUNS; do
              echo "Deleting run ID: $ID"
              gh api -X DELETE repos/$REPO/actions/runs/$ID 2>/dev/null || true
              COUNT=$((COUNT + 1))
            done
            echo "Deleted $COUNT workflow runs"
          fi
