name: Cleanup Artifacts

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      days_old:
        description: '删除多少天前的 artifacts (默认 0 = 删除所有)'
        required: false
        default: '0'
  # 每周一凌晨自动清理
  schedule:
    - cron: '0 0 * * 1'

permissions:
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const daysOld = parseInt('${{ github.event.inputs.days_old }}' || '0');
            const cutoffDate = daysOld > 0 
              ? new Date(Date.now() - daysOld * 24 * 60 * 60 * 1000)
              : null;
            
            console.log(`Deleting artifacts${cutoffDate ? ` older than ${daysOld} days` : ' (all)'}`);
            
            let deletedCount = 0;
            let totalSize = 0;
            let page = 1;
            
            while (true) {
              const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                page: page
              });
              
              if (artifacts.artifacts.length === 0) break;
              
              for (const artifact of artifacts.artifacts) {
                const createdAt = new Date(artifact.created_at);
                
                // 如果设置了天数限制，只删除超过该天数的
                if (cutoffDate && createdAt > cutoffDate) {
                  console.log(`Skipping: ${artifact.name} (created ${artifact.created_at})`);
                  continue;
                }
                
                console.log(`Deleting: ${artifact.name} (${(artifact.size_in_bytes / 1024 / 1024).toFixed(2)} MB, created ${artifact.created_at})`);
                
                try {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                  deletedCount++;
                  totalSize += artifact.size_in_bytes;
                } catch (error) {
                  console.log(`Failed to delete ${artifact.name}: ${error.message}`);
                }
              }
              
              page++;
            }
            
            console.log(`\n=== Summary ===`);
            console.log(`Deleted ${deletedCount} artifacts`);
            console.log(`Freed ${(totalSize / 1024 / 1024 / 1024).toFixed(2)} GB`);
